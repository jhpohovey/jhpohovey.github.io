<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Test</title>
  <link rel="stylesheet" href="../styles/reset.css">
  <link rel="stylesheet" href="../styles/variables.css">
  <style>
    body {
      padding: 2rem;
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      font-family: system-ui, -apple-system, sans-serif;
    }
    .test-section {
      margin-bottom: 3rem;
      padding: 1.5rem;
      border: 2px solid var(--color-border-light);
      border-radius: 8px;
    }
    .test-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
      color: var(--color-primary);
    }
    .test-result {
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 4px;
      font-weight: bold;
    }
    .test-pass {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .test-fail {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .test-warn {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    .test-description {
      margin-bottom: 1rem;
      color: var(--color-text-secondary);
    }
    .metrics {
      display: grid;
      gap: 1rem;
      margin-top: 1rem;
    }
    .metric {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      background: var(--color-bg-secondary);
      border-radius: 4px;
    }
    .metric-value {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Performance Contract Tests</h1>
  <p>Tests for performance budget compliance: page size, CSS/JS size, load time, and resource optimization.</p>

  <div id="test-container"></div>

  <script type="module">
    const tests = [];
    let passCount = 0;
    let failCount = 0;
    let warnCount = 0;

    // Performance budgets from spec
    const BUDGETS = {
      maxPageSize: 500 * 1024, // 500KB
      maxCSSSize: 50 * 1024,   // 50KB
      maxJSSize: 50 * 1024,    // 50KB
      maxImageSize: 100 * 1024, // 100KB per image
      maxLoadTime: 1500,        // 1.5s on 3G
      maxRequests: 20           // Max HTTP requests
    };

    function addTest(name, description, testFn) {
      tests.push({ name, description, testFn });
    }

    async function runTests() {
      const container = document.getElementById('test-container');
      
      for (const test of tests) {
        const section = document.createElement('div');
        section.className = 'test-section';
        
        const title = document.createElement('div');
        title.className = 'test-title';
        title.textContent = test.name;
        section.appendChild(title);

        const description = document.createElement('div');
        description.className = 'test-description';
        description.textContent = test.description;
        section.appendChild(description);

        try {
          const resultType = await test.testFn(section);
          const result = document.createElement('div');
          
          if (resultType === 'warn') {
            result.className = 'test-result test-warn';
            result.textContent = '⚠ WARNING';
            warnCount++;
          } else {
            result.className = 'test-result test-pass';
            result.textContent = '✓ PASS';
            passCount++;
          }
          
          section.appendChild(result);
        } catch (error) {
          const result = document.createElement('div');
          result.className = 'test-result test-fail';
          result.textContent = `✗ FAIL: ${error.message}`;
          section.appendChild(result);
          failCount++;
        }

        container.appendChild(section);
      }

      // Summary
      const summary = document.createElement('div');
      summary.className = 'test-section';
      summary.innerHTML = `
        <div class="test-title">Test Summary</div>
        <p>Total: ${tests.length} | Pass: ${passCount} | Warning: ${warnCount} | Fail: ${failCount}</p>
      `;
      container.appendChild(summary);
    }

    function formatBytes(bytes) {
      return `${(bytes / 1024).toFixed(2)} KB`;
    }

    // TEST 1: CSS bundle size
    addTest(
      'Test 1: CSS Bundle Size',
      'Total CSS should be under 50KB',
      async (section) => {
        const cssLinks = document.querySelectorAll('link[rel="stylesheet"]');
        let totalSize = 0;
        
        for (const link of cssLinks) {
          try {
            const response = await fetch(link.href);
            const text = await response.text();
            const size = new Blob([text]).size;
            totalSize += size;
          } catch (e) {
            // Ignore fetch errors for this test
          }
        }
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>Total CSS Size:</span>
            <span class="metric-value">${formatBytes(totalSize)}</span>
          </div>
          <div class="metric">
            <span>Budget:</span>
            <span class="metric-value">${formatBytes(BUDGETS.maxCSSSize)}</span>
          </div>
          <div class="metric">
            <span>Status:</span>
            <span class="metric-value">${totalSize <= BUDGETS.maxCSSSize ? '✓ Under budget' : '✗ Over budget'}</span>
          </div>
        `;
        section.appendChild(metrics);
        
        if (totalSize > BUDGETS.maxCSSSize) {
          throw new Error(`CSS size ${formatBytes(totalSize)} exceeds budget ${formatBytes(BUDGETS.maxCSSSize)}`);
        }
      }
    );

    // TEST 2: JS bundle size
    addTest(
      'Test 2: JavaScript Bundle Size',
      'Total JavaScript should be under 50KB',
      async (section) => {
        const scripts = document.querySelectorAll('script[src]');
        let totalSize = 0;
        
        for (const script of scripts) {
          try {
            const response = await fetch(script.src);
            const text = await response.text();
            const size = new Blob([text]).size;
            totalSize += size;
          } catch (e) {
            // Ignore fetch errors
          }
        }
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>Total JS Size:</span>
            <span class="metric-value">${formatBytes(totalSize)}</span>
          </div>
          <div class="metric">
            <span>Budget:</span>
            <span class="metric-value">${formatBytes(BUDGETS.maxJSSize)}</span>
          </div>
        `;
        section.appendChild(metrics);
        
        if (totalSize > BUDGETS.maxJSSize) {
          throw new Error(`JS size ${formatBytes(totalSize)} exceeds budget`);
        }
      }
    );

    // TEST 3: Page load performance
    addTest(
      'Test 3: Page Load Time',
      'Page should load within 1.5s (simulated 3G)',
      async (section) => {
        if (!window.performance || !window.performance.timing) {
          section.appendChild(document.createTextNode('Performance API not available'));
          return;
        }
        
        const timing = window.performance.timing;
        const loadTime = timing.loadEventEnd - timing.navigationStart;
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>Load Time:</span>
            <span class="metric-value">${loadTime}ms</span>
          </div>
          <div class="metric">
            <span>Budget:</span>
            <span class="metric-value">${BUDGETS.maxLoadTime}ms</span>
          </div>
        `;
        section.appendChild(metrics);
        
        // Note: This is actual load time, not throttled
        if (loadTime > BUDGETS.maxLoadTime) {
          section.appendChild(document.createTextNode(' (Note: Test on real 3G connection for accuracy)'));
          return 'warn';
        }
      }
    );

    // TEST 4: Number of HTTP requests
    addTest(
      'Test 4: HTTP Requests Count',
      'Should minimize HTTP requests (target: <20)',
      async (section) => {
        const resources = performance.getEntriesByType('resource');
        const count = resources.length;
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>Total Requests:</span>
            <span class="metric-value">${count}</span>
          </div>
          <div class="metric">
            <span>Budget:</span>
            <span class="metric-value">${BUDGETS.maxRequests}</span>
          </div>
        `;
        section.appendChild(metrics);
        
        if (count > BUDGETS.maxRequests) {
          return 'warn';
        }
      }
    );

    // TEST 5: Image optimization
    addTest(
      'Test 5: Image Sizes',
      'Images should be under 100KB each',
      async (section) => {
        const images = performance.getEntriesByType('resource').filter(r => 
          r.name.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)
        );
        
        let overBudget = 0;
        images.forEach(img => {
          if (img.transferSize > BUDGETS.maxImageSize) {
            overBudget++;
          }
        });
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>Total Images:</span>
            <span class="metric-value">${images.length}</span>
          </div>
          <div class="metric">
            <span>Over Budget:</span>
            <span class="metric-value">${overBudget}</span>
          </div>
        `;
        section.appendChild(metrics);
        
        if (overBudget > 0) {
          throw new Error(`${overBudget} images exceed 100KB`);
        }
      }
    );

    // TEST 6: CSS minification
    addTest(
      'Test 6: CSS Minification',
      'Production CSS should be minified',
      async (section) => {
        // Check if CSS has unnecessary whitespace
        const cssLinks = document.querySelectorAll('link[rel="stylesheet"]');
        
        if (cssLinks.length === 0) {
          section.appendChild(document.createTextNode('No CSS files to check'));
          return;
        }
        
        section.appendChild(document.createTextNode(`${cssLinks.length} CSS files found (manual minification check required for production)`));
      }
    );

    // TEST 7: Resource caching headers
    addTest(
      'Test 7: Caching Strategy',
      'Static assets should have cache headers',
      async (section) => {
        const resources = performance.getEntriesByType('resource');
        
        // This test would need server-side headers, placeholder for now
        section.appendChild(document.createTextNode('Cache headers check (requires server configuration)'));
      }
    );

    // TEST 8: Lazy loading images
    addTest(
      'Test 8: Lazy Loading',
      'Non-critical images should use lazy loading',
      async (section) => {
        const images = document.querySelectorAll('img');
        const lazyImages = document.querySelectorAll('img[loading="lazy"]');
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>Total Images:</span>
            <span class="metric-value">${images.length}</span>
          </div>
          <div class="metric">
            <span>Lazy Loaded:</span>
            <span class="metric-value">${lazyImages.length}</span>
          </div>
        `;
        section.appendChild(metrics);
      }
    );

    // TEST 9: First Contentful Paint
    addTest(
      'Test 9: First Contentful Paint',
      'FCP should be under 1.5s',
      async (section) => {
        const paintEntries = performance.getEntriesByType('paint');
        const fcp = paintEntries.find(entry => entry.name === 'first-contentful-paint');
        
        if (!fcp) {
          section.appendChild(document.createTextNode('FCP metric not available'));
          return;
        }
        
        const fcpTime = fcp.startTime;
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>FCP:</span>
            <span class="metric-value">${fcpTime.toFixed(2)}ms</span>
          </div>
          <div class="metric">
            <span>Budget:</span>
            <span class="metric-value">${BUDGETS.maxLoadTime}ms</span>
          </div>
        `;
        section.appendChild(metrics);
        
        if (fcpTime > BUDGETS.maxLoadTime) {
          return 'warn';
        }
      }
    );

    // TEST 10: Critical CSS inline
    addTest(
      'Test 10: Critical CSS',
      'Above-the-fold CSS should be inlined (production)',
      async (section) => {
        const inlineStyles = document.querySelectorAll('style');
        
        section.appendChild(document.createTextNode(`${inlineStyles.length} inline style blocks (check for critical CSS in production)`));
      }
    );

    // TEST 11: Font loading
    addTest(
      'Test 11: Font Loading',
      'Fonts should use font-display: swap',
      async (section) => {
        const fontFaces = document.fonts;
        
        section.appendChild(document.createTextNode('Font loading strategy (system fonts used, no external fonts)'));
      }
    );

    // TEST 12: DOM size
    addTest(
      'Test 12: DOM Size',
      'DOM should have reasonable number of elements (<1500)',
      async (section) => {
        const elements = document.querySelectorAll('*').length;
        
        const metrics = document.createElement('div');
        metrics.className = 'metrics';
        metrics.innerHTML = `
          <div class="metric">
            <span>DOM Elements:</span>
            <span class="metric-value">${elements}</span>
          </div>
          <div class="metric">
            <span>Recommended:</span>
            <span class="metric-value">&lt; 1500</span>
          </div>
        `;
        section.appendChild(metrics);
        
        if (elements > 1500) {
          return 'warn';
        }
      }
    );

    // Run all tests
    runTests();
  </script>
</body>
</html>
